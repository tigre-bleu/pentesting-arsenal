#!/bin/bash

SCRIPT=`realpath $0`
SCRIPTPATH=`dirname $SCRIPT`
WEAPONS_PATH="$SCRIPTPATH/../weapons"
LISTS_PATH="$SCRIPTPATH/../lists"
UTILS_PATH="$SCRIPTPATH"
CONFIG_CUSTOM_FILE="$SCRIPTPATH/../conf/custom.conf"
CONFIG_DEFAULT_FILE="$SCRIPTPATH/../conf/default.conf"

if test -f "$CONFIG_CUSTOM_FILE"; then
	CONFIG_FILE=$CONFIG_CUSTOM_FILE
else
	CONFIG_FILE=$CONFIG_DEFAULT_FILE
	echo "No custom configuration. Loading default one"
fi

source $CONFIG_FILE

read -p "Project Name: " NEW_PROJECT_NAME
read -p "Project IP: " NEW_PROJECT_IP
read -p "LHOST Interface: " -e -i $LIFACE IFACE
read -p "Project parent folder: " -e -i $PROJECTS_PATH PROJECTS_PATH

NEW_PROJECT_PATH="$PROJECTS_PATH/$NEW_PROJECT_NAME"
ENV_SCRIPT="$NEW_PROJECT_PATH/.env"

echo "Creating new project folder: $NEW_PROJECT_PATH"

# Make project folder
/usr/bin/mkdir $NEW_PROJECT_PATH

# Create content files and folders
/usr/bin/ln -s $WEAPONS_PATH $NEW_PROJECT_PATH/Weapons
/usr/bin/ln -s $LISTS_PATH $NEW_PROJECT_PATH/Lists
/usr/bin/ln -s $UTILS_PATH $NEW_PROJECT_PATH/Utils
/usr/bin/touch $NEW_PROJECT_PATH/$NEW_PROJECT_NAME.md

# Generate env script
echo "export UTILS=$UTILS_PATH" >> $ENV_SCRIPT
echo "export RHOST=$NEW_PROJECT_IP" >> $ENV_SCRIPT
echo "PATH=$PATH:$UTILS_PATH" >> $ENV_SCRIPT
echo "alias cs='cheatsheet.py'" >> $ENV_SCRIPT

# LHOST IP in env script

echo "LHOST_IP=\$(ip addr show $IFACE | grep -Po 'inet \K[\d.]+')" >> $ENV_SCRIPT
echo "export LHOST=\$LHOST_IP" >> $ENV_SCRIPT

# Display Env Variables in env script
echo "echo \"Environment Variables:\"" >> $ENV_SCRIPT
echo "echo \"---------------------\"" >> $ENV_SCRIPT
echo "echo \"LHOST=\$LHOST\"" >> $ENV_SCRIPT
echo "echo \"RHOST=\$RHOST\"" >> $ENV_SCRIPT

echo "Project created"
